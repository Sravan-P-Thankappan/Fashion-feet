<div class="breadcrumb-area bg-gray " style="margin-top: 12rem;">
    <div class="container">
        <div class="breadcrumb-content text-center">
            <ul>

                <li class="active">Checkout </li>
            </ul>
        </div>
    </div>
</div>


<div class="checkout-main-area pt-120 pb-120">
    <div class="container">

        <div class="customer-zone mb-20">
            <p class="cart-page-title">Select Address <span></span><a class="checkout-click1" href="#">Click here</a>
            </p>
            <div class="checkout-login-info">

                <div class="accordion" id="accordionPanelsStayOpenExample">
                    <form action="" class="checkout-form">
                        {{#each address}}
                        <div class="accordion-item">
                            <div class="accordion-header" name="address" id="panelsStayOpen-heading{{this._id}}">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#panelsStayOpen-collapse{{this._id}}" aria-expanded="true"
                                    aria-controls="panelsStayOpen-collaps{{this._id}}" id="accordion1btn">


                                    <input class="form-check-input chkAll me-2" name="address" type="radio" required
                                        value="{{this._id}}" id="chkAccordion1All">{{this.addressDetail.Housename}}


                                </button>
                            </div>
                            <div id="panelsStayOpen-collapse{{this._id}}" class="accordion-collapse collapse"
                                aria-labelledby="panelsStayOpen-headingOne">
                                <div class="accordion-body ms-3">

                                    <input class="border-0" readonly type="text"
                                        value="{{this.addressDetail.Housename}} , {{this.addressDetail.Streetname}}"><br>
                                    <input class="border-0" readonly type="text"
                                        value="{{this.addressDetail.State}} , {{this.addressDetail.Pin}}"><br>
                                    {{!-- <input class="border-0" readonly type="text"
                                        value="{{this.addressDetail.mobile}} , {{this.addressDetail.email}}"> --}}

                                </div>
                            </div>
                        </div>
                        {{/each}}
                    </form>

                </div>


            </div>
        </div>

        <div class="customer-zone mb-20">
            <p class="cart-page-title">Have a coupon? <a class="checkout-click3" href="#">Click here to enter your
                    code</a></p>
            <div class="checkout-login-info3">
                <form id="coupon-form">
                    <input type="text" id="userId" name="user" value="{{login._id}}" hidden>
                    <input type="number" id="coupontotal" name="total" value="{{total.total}}" hidden required>
                    <input type="text" name="coupon" placeholder="Coupon code">
                    <input class="mt-2" type="submit" value="Apply Coupon">
                    <br>
                    <label class="text-danger mt-2" id="coupenError" for=""></label>
                </form>
            </div>
        </div>

        <div class="customer-zone mb-20">
            <p class="cart-page-title">Have Wallet? <a class="checkout-click7" href="#">Click here
                </a></p>
            <div class="checkout-login-info7">
                <form id="wallet-form">

                    {{!-- <input type="text" id="userId" , name="user" value="{{login._id}}" hidden> --}}
                    <input type="text" name="total" id="wallettotal" value="{{total.total}}" hidden>

                    <input class="text-dark" type="number" id="wallet1" value="{{user.Wallet}}" readonly>

                    <input class="" type="number" name="wallet">
                    <input class="mt-2" type="submit" value="Apply Wallet">
                    <br>
                    <label class="text-danger" id="walleterr"></label>
                </form>
            </div>
        </div>








        <div class="checkout-wrap pt-30">
            <div class="row">
                <div class="col-lg-7">

                    <form id="add-addressform" action="/addaddresstwo" method="post">

                        <div class="billing-info-wrap mr-50">

                            <h3>Billing Details</h3>



                            <div class="row">


                                <div class="col-lg-6 col-md-6">

                                    <div class="billing-info mb-20">

                                        <input type="text" id="userid" name="userId" value="{{login._id}}" hidden>
                                    </div>
                                </div>


                                <div class="col-lg-12">
                                    <div class="billing-info mb-20">
                                        <label>House Name<abbr class="required" title="required">*</abbr></label>

                                        <label class="text-danger" id="caddress-error" for=""></label>

                                        <input class="billing-address" placeholder="" type="text" id="address"
                                            name="Housename" onkeyup="validatecAddress()">

                                    </div>
                                </div>

                                <div class="col-lg-12">
                                    <div class="billing-info mb-20">
                                        <label id="ctown-error" class="text-danger" for=""></label>
                                        <label>Town / City <abbr class="required" title="required">*</abbr></label>
                                        <input type="text" id="town" name="Streetname" onkeyup="validatecTown()">

                                    </div>
                                </div>

                                <div class="col-lg-12 col-md-12">
                                    <div class="billing-info mb-20">
                                        <label for="" class="text-danger" id="cstate-error"></label>
                                        <label>State <abbr class="required" title="required">*</abbr></label>

                                        <input type="text" id="state" name="State" onkeyup="validatecState()">

                                    </div>
                                </div>
                                <div class="col-lg-12 col-md-12">
                                    <div class="billing-info mb-20">
                                        <label>Postcode / ZIP <abbr class="required" title="required">*</abbr></label>
                                        <label class="text-danger" id="cpincode-error" for=""></label>
                                        <input type="number" id="pincode" name="Pin" onkeyup="validatecPin()">

                                    </div>
                                </div>


                                <div class="col-lg-12 col-md-12">
                                    <div class="billing-info mb-20">

                                        <button class="px-3 py-1 btn btn-danger" type="submit"
                                            onclick="return validatecform()">Submit</button>
                                        <label class="text-danger" id="walleter" for=""></label>

                                    </div>
                                </div>


                            </div>

                            <label class="text-danger" id="submitEr" for=""></label>



                        </div>
                    </form>
                </div>






                <div class="col-lg-5">

                    <div class="your-order-area">
                        <h3>Your order</h3>
                        <form class="checkout-form">
                            <div class="your-order-wrap gray-bg-4">
                                <div class="your-order-info-wrap">
                                    <div class="your-order-info">
                                        <ul>
                                            <li>Product <span>Total</span></li>
                                        </ul>
                                    </div>

                                    <div class="your-order-info order-subtotal">
                                        <ul>
                                            <li>Subtotal <span id="">{{total.subtotal}}</span></li>
                                        </ul>
                                    </div>

                                    {{!-- <input type="number" value="{{total.subtotal}}" name="subtotal" hidden> --}}


                                    <div class="your-order-info order-subtotal">
                                        <ul>
                                            <li>Discount<span id="">{{total.discount}}</span></li>
                                        </ul>
                                    </div>

                                    <div class="your-order-info order-subtotal">
                                        <ul>
                                            <li>Coupon Offer<span id="coupon">0</span></li>
                                        </ul>
                                    </div>
                                    <div class="your-order-info order-subtotal">
                                        <ul>
                                            <li>Wallet Offer<span id="wallet">0</span></li>
                                        </ul>
                                    </div>


                                    <div class="your-order-info order-shipping">
                                        <ul>
                                            <li>Shipping <p>Free </p>
                                            </li>
                                        </ul>
                                    </div>

                                    <div class="your-order-info order-total">
                                        <ul>
                                            <li>Total <span id="totalvalue">{{total.total}} </span></li>
                                        </ul>
                                    </div>

                                </div>

                                <div class="payment-method">

                                    <div class="pay-top sin-payment">

                                        <input type="" id="totalvalue2" value="{{total.total}}" name="total" hidden>
                                        <input type="number" id="discount" value="{{total.discount}}" name="discount"
                                            hidden>
                                        <input type="text" id="coupon2" value="0" name="couponoffer" hidden required>

                                        <input type="number" id="wallet2" value="0" name="walletoffer" hidden>

                                        <input id="payment-method-3" class="input-radio" type="radio" value="COD"
                                            name="paymentmethod" required>

                                        <label for="payment-method-3">Cash on delivery </label>

                                        <div class="payment-box payment_method_bacs">
                                            <p>Make your payment directly into our bank account. Please use your Order
                                                ID as
                                                the payment reference.</p>
                                        </div>
                                    </div>

                                    <div class="pay-top sin-payment sin-payment-3">

                                        <input id="payment-method-4" class="input-radio" type="radio" value="Razorpay"
                                            name="paymentmethod" required>

                                        <label for="payment-method-4">Razorpay<img alt=""
                                                src="assets/images/icon-img/payment.png"><a href="#">What is
                                                RazorPay?</a></label>
                                        <div class="payment-box payment_method_bacs">
                                            <p>Make your payment directly into our bank account. Please use your Order
                                                ID as
                                                the payment reference.</p>
                                        </div>
                                    </div>

                                    <div class="pay-top sin-payment sin-payment-3">

                                        <input id="payment-method-5" class="input-radio" type="radio" value="Paypal"
                                            name="paymentmethod" required>

                                        <label for="payment-method-4">Pay Pal<img alt=""
                                                src="assets/images/icon-img/payment.png"><a href="#">What is
                                                Paypal?</a></label>
                                        <div class="payment-box payment_method_bacs">
                                            <p>Make your payment directly into our bank account. Please use your Order
                                                ID as
                                                the payment reference.</p>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="Place-order">

                                <button class="px-3 py-1 btn btn-danger" type="submit" onclick="return checkAddress()">Place Order</button>
                            </div>
                            <label id="addaddresser" class="text-danger mt-3" for=""></label>
                        </form>
                    </div>



                </div>

                {{!-- </form> --}}
            </div>
        </div>
    </div>
</div>
</div>



<script>


    $(".checkout-form").submit((e) => {


        e.preventDefault()

        $.ajax({
            url: '/place-order',
            method: 'post',
            data: $('.checkout-form').serialize(),

            success: (response) => {

                if (response.codSuccess) {
                    location.href = '/orderlist'
                }
                else if (response.razorpaySuccess) {
                    console.log(response)
                    console.log('asdfghj')
                    razorpayPayment(response)

                }
                else {

                    console.log("paypal starts")

                    for (let i = 0; i < response.links.length; i++) {
                        if (response.links[i].rel === 'approval_url') {
                            location.href = response.links[i].href

                            console.log("paypal final")
                        }
                    }
                }
            }
        })
    })


    function razorpayPayment(order) {


        var options = {
            "key": "rzp_test_tktJ5Z7OxNsc7R", // Enter the Key ID generated from the Dashboard
            "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "INR",
            "name": "Fashion Feet",
            "description": "Test Transaction",
            "image": "",
            "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "handler": function (response) {

                {
                    {
                        alert(response.razorpay_payment_id);
                        alert(response.razorpay_order_id);
                        alert(response.razorpay_signature)
                    }
                }

                verifyPayment(response, order)
            },
            "prefill": {
                "name": "Gaurav Kumar",
                "email": "gaurav.kumar@example.com",
                "contact": "9999999999"
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {
                "color": "#861939"
            }
        };

        var rzp1 = new Razorpay(options)

        rzp1.open();
    }


    function verifyPayment(payment, order) {
        console.log(payment, order)

        $.ajax({

            url: '/verifypayment',
            data: {
                payment,
                order
            },
            method: 'post',

            success: (response) => {

                if (response.status) {
                    location.href = '/orderlist'
                } else {
                    alert('payment failed')
                }
            }
        })
    }


 function checkAddress(){
    var getValue = document.querySelector('input[name="address"]:checked')
    if(getValue!=null)
    {
        return true;
    }
    else{
        document.getElementById('addaddresser').innerHTML='Select Address'
        return false();
    }
 }
</script>